<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proces: Změna představení — Jihočeské divadlo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#0f1117;--sf:#1a1d27;--sf2:#242836;--bd:#2e3348;--tx:#e2e4ed;--txd:#8b90a5;--ac:#6c7bf7;--w:#f59e0b; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--tx);height:100vh;overflow:hidden;display:flex;flex-direction:column}
    header{background:var(--sf);border-bottom:1px solid var(--bd);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:10}
    header h1{font-size:15px;font-weight:700}
    header .sub{font-size:11px;color:var(--txd);font-family:'JetBrains Mono',monospace;margin-top:2px}
    .ctrls{display:flex;align-items:center;gap:6px}
    .ctrls button{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);width:32px;height:32px;border-radius:6px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background .15s}
    .ctrls button:hover{background:var(--bd)}
    .ctrls .tb{width:auto;padding:0 12px;font-size:11px}
    .ctrls .zl{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txd);width:44px;text-align:center}
    .tabs{display:flex;gap:2px;margin-left:20px}
    .tabs button{background:0;border:0;color:var(--txd);font-family:'DM Sans',sans-serif;font-size:12px;padding:6px 14px;border-radius:6px;cursor:pointer;transition:all .15s}
    .tabs button:hover{color:var(--tx);background:var(--sf2)}
    .tabs button.on{color:var(--ac);background:rgba(108,123,247,.1)}
    #cw{flex:1;overflow:hidden;cursor:grab;position:relative}
    #cw:active{cursor:grabbing}
    .tip{position:fixed;background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--tx);max-width:300px;pointer-events:none;z-index:100;box-shadow:0 8px 32px rgba(0,0,0,.6);display:none;line-height:1.5}
    .tip b{display:block;margin-bottom:4px}
    .tip .pw{color:var(--w);font-size:11px;margin-top:6px;padding-top:6px;border-top:1px solid var(--bd)}
    .pp{position:absolute;right:16px;top:16px;width:310px;background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:16px;z-index:20;max-height:calc(100% - 32px);overflow-y:auto;display:none;box-shadow:0 8px 32px rgba(0,0,0,.4)}
    .pp.vis{display:block}
    .pp h3{font-size:13px;margin-bottom:12px}
    .pp .pi{padding:8px 10px;border-radius:6px;margin-bottom:6px;font-size:11px;line-height:1.5;background:rgba(245,158,11,.1);border-left:3px solid var(--w)}
    .pp .pi span{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--w);font-weight:600}
    .pp .cx{position:absolute;top:12px;right:12px;background:0;border:0;color:var(--txd);cursor:pointer;font-size:16px}
    footer{background:var(--sf);border-top:1px solid var(--bd);padding:8px 20px;display:flex;justify-content:space-between;font-size:10px;color:var(--txd);font-family:'JetBrains Mono',monospace;flex-shrink:0}
  </style>
</head>
<body>
<header>
  <div><h1>Proces: Změna / zrušení představení</h1><div class="sub">Jihočeské divadlo · AS-IS · digitální audit 2025/2026</div></div>
  <div class="tabs"><button class="on" id="tD">Diagram</button><button id="tP">⚠ Problémy (8)</button></div>
  <div class="ctrls"><button id="zi">+</button><span class="zl" id="zl">72%</span><button id="zo">−</button><button class="tb" id="zr">Reset</button></div>
</header>
<div id="cw">
  <canvas id="c"></canvas>
  <div class="pp" id="pp">
    <button class="cx" id="ppx">✕</button>
    <h3>⚠️ Identifikované problémy</h3>
    <div class="pi"><span>P1</span> Nestrukturovaný vstup změny — telefon, mail, WA, osobně. Riziko ztráty informace.</div>
    <div class="pi"><span>P2</span> Single point of failure — zápis do Fermana může pouze Milena. Při nepřítomnosti se proces zastaví.</div>
    <div class="pi"><span>P3</span> Ruční přepis do 5+ nepropojených systémů — 5–10 h/týden, riziko nekonzistence dat.</div>
    <div class="pi"><span>P4</span> Chybí formalizovaná kategorizace závažnosti změn.</div>
    <div class="pi"><span>P5</span> Ferman nemá notifikace — zaměstnanci musí sami aktivně kontrolovat.</div>
    <div class="pi"><span>P6</span> Chybí potvrzení přijetí informace — nikdo neví, kdo o změně ví.</div>
    <div class="pi"><span>P7</span> UTP plán pouze na týden dopředu (ve čtvrtek pro příští týden).</div>
    <div class="pi"><span>P8</span> Opakované zkoušky se zadávají ručně — chybí funkce opakovaných událostí.</div>
  </div>
</div>
<div class="tip" id="tt"></div>
<footer><span>Scroll = zoom · Drag = posun · Hover = detail · ⚠️ = problémové místo</span><span>Mgr. Kateřina Švidrnochová · katerina@svidrnochova.cz</span></footer>

<script>
const P=[
  {id:"iniciator",lb:"Iniciátor změny",s:"(režisér, šéf souboru, produkční)",c:"#22c55e",y:0,h:120},
  {id:"vedeni",lb:"Vedení / Porada vedení",s:"",c:"#3b82f6",y:135,h:150},
  {id:"produkcni",lb:"Produkční souborů",s:"(Činohra, Opera, Balet, MD)",c:"#f97316",y:300,h:185},
  {id:"milena",lb:"Milena Chumlenová",s:"(tajemnice, správce Fermana)",c:"#ec4899",y:500,h:230},
  {id:"utp",lb:"UTP / Technici",s:"(Bajzeková, mistři)",c:"#a855f7",y:745,h:155},
  {id:"doprava",lb:"Doprava",s:"(Bajzeková)",c:"#06b6d4",y:915,h:120}
];
const ND=[
  {id:"s1",tp:0,x:190,y:55,pi:"iniciator",lb:"Potřeba změny"},
  {id:"t1",tp:1,x:280,y:28,pi:"iniciator",lb:"Nahlásit potřebu změny",sl:"⚠️ telefon/mail/WA/osobně",w:210,h:65,wn:1,tip:"Iniciátor komunikuje změnu nestrukturovaně — neexistuje formulář ani definovaný kanál.",prb:"P1: Nestrukturovaný vstup"},
  {id:"e1",tp:2,x:555,y:55},
  {id:"t2",tp:1,x:280,y:170,pi:"vedeni",lb:"Posoudit závažnost",sl:"⚠️ Neformalizováno",w:185,h:55,wn:1,tip:"Chybí formalizovaná kategorizace závažnosti změn.",prb:"P4: Chybí kategorizace"},
  {id:"g1",tp:3,x:530,y:190,lb:"Schválit?"},
  {id:"t3",tp:1,x:620,y:150,pi:"vedeni",lb:"Schválit změnu",sl:"Porada 1×/14 dní nebo ad hoc",w:200,h:55,tip:"Kritické změny na poradě vedení nebo ad hoc ředitelka."},
  {id:"t4",tp:1,x:620,y:225,pi:"vedeni",lb:"Zamítnout",w:120,h:40},
  {id:"e2",tp:2,x:880,y:170},{id:"e3",tp:2,x:790,y:238},
  {id:"t5",tp:1,x:190,y:340,pi:"produkcni",lb:"Přijmout info o změně",w:165,h:50,tip:"Info přichází od iniciátora k produkčnímu souboru."},
  {id:"g2",tp:3,x:415,y:358,lb:"Závažnost?"},
  {id:"t6",tp:1,x:510,y:315,pi:"produkcni",lb:"Eskalovat na vedení",sl:"(kritická změna)",w:175,h:50,tip:"Zrušení/přesunutí představení → dopad na diváky, prodej, UTP, dopravu."},
  {id:"t7",tp:1,x:510,y:395,pi:"produkcni",lb:"Rozhodnout samostatně",sl:"(důležitá/běžná)",w:175,h:50,tip:"Změna zkoušky/obsazení → rozhoduje produkční + Milena."},
  {id:"t8",tp:1,x:745,y:340,pi:"produkcni",lb:"Informovat Milenu",sl:"⚠️ Nejednotný kanál",w:175,h:55,wn:1,tip:"Mail, telefon, osobně, WA — nejednotně.",prb:"P1: Nestrukturovaný kanál"},
  {id:"t9",tp:1,x:980,y:340,pi:"produkcni",lb:"Aktualizovat tabulky souboru",sl:"Google / Excel",w:195,h:55,tip:"Opera: Google. Balet: Google. MD: Google. Činohra: Excel."},
  {id:"e4",tp:2,x:1230,y:360},
  {id:"t10",tp:1,x:190,y:530,pi:"milena",lb:"Přijmout požadavek",sl:"⚠️ Z různých kanálů",w:175,h:55,wn:1,tip:"Milena = centrální bod, „středobod, kde se to sbíhá".",prb:"P2: Single point of failure"},
  {id:"g3",tp:3,x:425,y:550,lb:"Urgentní?"},
  {id:"t11",tp:1,x:525,y:510,pi:"milena",lb:"Urgentní informování",sl:"WA / telefon / obvolání",w:180,h:50,tip:"Nejdřív WA/telefon, pak se doupraví ve Fermanu."},
  {id:"t12",tp:1,x:525,y:590,pi:"milena",lb:"Zapsat do .xlsx Fermana",sl:"⚠️ Pouze Milena má právo",w:200,h:55,wn:1,tip:"Milena jako jediná zapisuje do přípravné .xlsx tabulky.",prb:"P2: Při nepřítomnosti se proces zastaví"},
  {id:"t13",tp:1,x:775,y:590,pi:"milena",lb:"Ruční přepis do Fermana",sl:"⚠️ Žádné API",w:195,h:55,wn:1,tip:"Ruční přepis z .xlsx do webu. Opakované zkoušky pokaždé znovu.",prb:"P3: 5–10 h/týden + P8: Chybí opakování"},
  {id:"t14",tp:1,x:1010,y:530,pi:"milena",lb:"Aktualizovat měsíční plán",sl:"Excel / OneDrive",w:175,h:55,tip:"Ruční aktualizace. Tabulky nejsou propojené vzorci."},
  {id:"t15",tp:1,x:1010,y:615,pi:"milena",lb:"Aktualizovat tab. dopravy",sl:"Čtvrtek = Fermanka",w:180,h:55,tip:"Po Fermance přicházejí další telefonáty."},
  {id:"t16",tp:1,x:1230,y:570,pi:"milena",lb:"Aktualizovat nástěnku",sl:"Tisk Fermana → UTP",w:170,h:55,tip:"Fyzická nástěnka — tiskne Ferman, ale může být hned zastaralý."},
  {id:"e5",tp:2,x:1455,y:590},
  {id:"t17",tp:1,x:260,y:780,pi:"utp",lb:"Přijmout urgentní info",sl:"WA / telefon",w:175,h:50,tip:"WA skupiny, ale Jarmila nemá přístup do všech."},
  {id:"g4",tp:3,x:505,y:798,lb:"Zdroj?"},
  {id:"t18",tp:1,x:605,y:760,pi:"utp",lb:"Zkontrolovat Ferman",sl:"⚠️ Žádné notifikace",w:180,h:50,wn:1,tip:"Musí sami aktivně kontrolovat web.",prb:"P5: Neví o změnách"},
  {id:"t19",tp:1,x:605,y:835,pi:"utp",lb:"Přečíst nástěnku",sl:"⚠️ Může být zastaralá",w:180,h:50,wn:1,tip:"Technici nemají PC ani smartphony.",prb:"P7: Horizont jen 1 týden"},
  {id:"t20",tp:1,x:860,y:785,pi:"utp",lb:"Upravit pracovní plán",w:175,h:50,tip:"Chybí potvrzení přijetí.",prb:"P6: Nikdo neví, kdo ví"},
  {id:"e6",tp:2,x:1100,y:803},
  {id:"t21",tp:1,x:260,y:945,pi:"doprava",lb:"Přijmout info o změně",sl:"Urgentní / Fermanka",w:190,h:50,tip:"Jarmila: Fermanka (čtvrtek) nebo urgentně."},
  {id:"t22",tp:1,x:520,y:945,pi:"doprava",lb:"Upravit rozvrh dopravy",sl:"⚠️ Ruční v Excelu",w:195,h:50,wn:1,tip:"Chybí buffery mezi cestami řidičů.",prb:"P3: Ruční, bez automatizace"},
  {id:"t23",tp:1,x:785,y:945,pi:"doprava",lb:"Informovat řidiče",sl:"Telefonicky / osobně",w:175,h:50,tip:"Řidiči nemají digitální přístup."},
  {id:"e7",tp:2,x:1025,y:963}
];
const ED=[
  ["s1","t1"],["t1","e1"],
  ["t2","g1"],["g1","t3","Ano"],["g1","t4","Ne"],["t3","e2"],["t4","e3"],
  ["t5","g2"],["g2","t6","Kritická"],["g2","t7","Běžná"],["t6","t8"],["t7","t8"],["t8","t9"],["t9","e4"],
  ["t10","g3"],["g3","t11","Ano"],["g3","t12","Ne"],["t11","t12"],["t12","t13"],["t13","t14"],["t13","t15"],["t14","t16"],["t15","t16"],["t16","e5"],
  ["t17","g4"],["g4","t18","Online"],["g4","t19","Offline"],["t18","t20"],["t19","t20"],["t20","e6"],
  ["t21","t22"],["t22","t23"],["t23","e7"]
];
const MF=[
  ["t1","t5","Nahlášení"],["t6","t2","Eskalace"],["t3","t8","Rozhodnutí"],
  ["t8","t10","Info Mileně"],["t11","t17","Urgentní info"],["t11","t21","Urgentní info"],["t15","t22","Aktualizace"]
];

const cv=document.getElementById("c"), ct=cv.getContext("2d");
const nm={}; ND.forEach(n=>nm[n.id]=n);
let sc=.72,ox=10,oy=10,dr=false,dsx=0,dsy=0,hov=null;
const D=window.devicePixelRatio||1;

function rs(){const w=document.getElementById("cw");cv.width=w.clientWidth*D;cv.height=w.clientHeight*D;cv.style.width=w.clientWidth+"px";cv.style.height=w.clientHeight+"px";dd()}
function ctr(n){if(n.tp===0||n.tp===2)return{x:n.x,y:n.y};if(n.tp===3)return{x:n.x,y:n.y};return{x:n.x+(n.w||160)/2,y:n.y+(n.h||50)/2}}
function prt(n,s){const c=ctr(n);if(n.tp===0||n.tp===2||n.tp===3){const r=n.tp===3?20:14;if(s==="r")return{x:c.x+r,y:c.y};if(s==="l")return{x:c.x-r,y:c.y};if(s==="b")return{x:c.x,y:c.y+r};return{x:c.x,y:c.y-r}}const w=n.w||160,h=n.h||50;if(s==="r")return{x:n.x+w,y:n.y+h/2};if(s==="l")return{x:n.x,y:n.y+h/2};if(s==="b")return{x:n.x+w/2,y:n.y+h};return{x:n.x+w/2,y:n.y}}
function bsd(a,b){const ac=ctr(a),bc=ctr(b),dx=bc.x-ac.x,dy=bc.y-ac.y;if(Math.abs(dx)>Math.abs(dy))return dx>0?["r","l"]:["l","r"];return dy>0?["b","t"]:["t","b"]}
function h2a(h,a){return`rgba(${parseInt(h.slice(1,3),16)},${parseInt(h.slice(3,5),16)},${parseInt(h.slice(5,7),16)},${a})`}
function rr(x,y,w,h,r){ct.beginPath();ct.moveTo(x+r,y);ct.lineTo(x+w-r,y);ct.quadraticCurveTo(x+w,y,x+w,y+r);ct.lineTo(x+w,y+h-r);ct.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ct.lineTo(x+r,y+h);ct.quadraticCurveTo(x,y+h,x,y+h-r);ct.lineTo(x,y+r);ct.quadraticCurveTo(x,y,x+r,y);ct.closePath()}
function ar(x1,y1,x2,y2,o){const{ds,co="#4b5563",lb,al=1}=o||{};ct.save();ct.globalAlpha=al;ct.strokeStyle=co;ct.lineWidth=ds?1:1.5;if(ds)ct.setLineDash([5,3]);ct.beginPath();ct.moveTo(x1,y1);ct.lineTo(x2,y2);ct.stroke();ct.setLineDash([]);const a=Math.atan2(y2-y1,x2-x1),hl=7;ct.fillStyle=co;ct.beginPath();ct.moveTo(x2,y2);ct.lineTo(x2-hl*Math.cos(a-Math.PI/6),y2-hl*Math.sin(a-Math.PI/6));ct.lineTo(x2-hl*Math.cos(a+Math.PI/6),y2-hl*Math.sin(a+Math.PI/6));ct.closePath();ct.fill();if(lb){ct.fillStyle=co;ct.font="500 9px 'DM Sans',sans-serif";ct.textAlign="center";ct.fillText(lb,(x1+x2)/2,(y1+y2)/2-5)}ct.restore()}

function dd(){
  ct.save();ct.scale(D,D);ct.clearRect(0,0,cv.width,cv.height);ct.translate(ox,oy);ct.scale(sc,sc);
  P.forEach(p=>{ct.fillStyle=h2a(p.c,.04);rr(140,p.y,1380,p.h,6);ct.fill();ct.strokeStyle=h2a(p.c,.2);ct.lineWidth=1;rr(140,p.y,1380,p.h,6);ct.stroke();ct.fillStyle=h2a(p.c,.12);rr(0,p.y,135,p.h,6);ct.fill();ct.strokeStyle=h2a(p.c,.4);ct.lineWidth=1.5;rr(0,p.y,135,p.h,6);ct.stroke();ct.fillStyle=p.c;ct.font="700 11px 'DM Sans',sans-serif";ct.textAlign="center";ct.fillText(p.lb,67,p.y+p.h/2-(p.s?4:0));if(p.s){ct.globalAlpha=.7;ct.font="400 8.5px 'DM Sans',sans-serif";ct.fillText(p.s,67,p.y+p.h/2+12);ct.globalAlpha=1}});
  ED.forEach(e=>{const fn=nm[e[0]],tn=nm[e[1]];if(!fn||!tn)return;const[fs,ts]=bsd(fn,tn);const p1=prt(fn,fs),p2=prt(tn,ts);ar(p1.x,p1.y,p2.x,p2.y,{lb:e[2]})});
  MF.forEach(m=>{const fn=nm[m[0]],tn=nm[m[1]];if(!fn||!tn)return;const[fs,ts]=bsd(fn,tn);const p1=prt(fn,fs),p2=prt(tn,ts);ar(p1.x,p1.y,p2.x,p2.y,{ds:1,co:"#a78bfa",lb:m[2],al:.65})});
  ND.forEach(n=>{
    if(n.tp===0){const pc=P.find(p=>p.id===n.pi);const co=pc?pc.c:"#22c55e";ct.strokeStyle=co;ct.lineWidth=2.5;ct.beginPath();ct.arc(n.x,n.y,14,0,Math.PI*2);ct.stroke();ct.fillStyle=co;ct.beginPath();ct.arc(n.x,n.y,5,0,Math.PI*2);ct.fill();if(n.lb){ct.fillStyle="#6b7280";ct.font="400 8px 'DM Sans',sans-serif";ct.textAlign="center";ct.fillText(n.lb,n.x,n.y+26)}}
    else if(n.tp===2){ct.strokeStyle="#ef4444";ct.lineWidth=3;ct.beginPath();ct.arc(n.x,n.y,14,0,Math.PI*2);ct.stroke();ct.fillStyle="#ef4444";ct.beginPath();ct.arc(n.x,n.y,6,0,Math.PI*2);ct.fill()}
    else if(n.tp===3){const s=20;ct.fillStyle="#fef3c7";ct.beginPath();ct.moveTo(n.x,n.y-s);ct.lineTo(n.x+s,n.y);ct.lineTo(n.x,n.y+s);ct.lineTo(n.x-s,n.y);ct.closePath();ct.fill();ct.strokeStyle="#f59e0b";ct.lineWidth=2;ct.beginPath();ct.moveTo(n.x,n.y-s);ct.lineTo(n.x+s,n.y);ct.lineTo(n.x,n.y+s);ct.lineTo(n.x-s,n.y);ct.closePath();ct.stroke();ct.fillStyle="#92400e";ct.font="bold 12px sans-serif";ct.textAlign="center";ct.fillText("✕",n.x,n.y+5);if(n.lb){ct.fillStyle="#6b7280";ct.font="400 8px 'DM Sans',sans-serif";ct.fillText(n.lb,n.x,n.y-s-6)}}
    else{const w=n.w||160,h=n.h||50,ih=hov===n.id;ct.fillStyle="rgba(0,0,0,.15)";rr(n.x+2,n.y+2,w,h,8);ct.fill();ct.fillStyle=n.wn?"#1c1a14":"#1a1d27";rr(n.x,n.y,w,h,8);ct.fill();ct.strokeStyle=ih?"#6c7bf7":n.wn?"#f59e0b":"#3f4560";ct.lineWidth=ih?2.5:n.wn?2:1.5;rr(n.x,n.y,w,h,8);ct.stroke();if(n.wn){ct.fillStyle="#f59e0b";rr(n.x,n.y,4,h,2);ct.fill()}ct.fillStyle="#e2e4ed";ct.font="600 10.5px 'DM Sans',sans-serif";ct.textAlign="center";n.lb.split("\n").forEach((l,i)=>ct.fillText(l,n.x+w/2,n.y+16+i*13));if(n.sl){ct.fillStyle=n.wn?"#fbbf24":"#6b7280";ct.font="400 8.5px 'JetBrains Mono',monospace";ct.fillText(n.sl,n.x+w/2,n.y+h-8)}}
  });
  // Legend
  const ly=1060;ct.fillStyle="rgba(248,250,252,.05)";rr(20,ly,540,70,6);ct.fill();ct.strokeStyle="rgba(226,232,240,.1)";ct.lineWidth=1;rr(20,ly,540,70,6);ct.stroke();
  ct.fillStyle="#94a3b8";ct.font="700 11px 'DM Sans',sans-serif";ct.textAlign="left";ct.fillText("Legenda",35,ly+18);
  ct.strokeStyle="#22c55e";ct.lineWidth=2;ct.beginPath();ct.arc(45,ly+40,7,0,Math.PI*2);ct.stroke();ct.fillStyle="#94a3b8";ct.font="400 9px 'DM Sans',sans-serif";ct.fillText("Start",58,ly+44);
  ct.strokeStyle="#ef4444";ct.lineWidth=2.5;ct.beginPath();ct.arc(120,ly+40,7,0,Math.PI*2);ct.stroke();ct.fillText("Konec",133,ly+44);
  ct.fillStyle="#fef3c7";ct.beginPath();ct.moveTo(210,ly+32);ct.lineTo(218,ly+40);ct.lineTo(210,ly+48);ct.lineTo(202,ly+40);ct.closePath();ct.fill();ct.strokeStyle="#f59e0b";ct.lineWidth=1.5;ct.beginPath();ct.moveTo(210,ly+32);ct.lineTo(218,ly+40);ct.lineTo(210,ly+48);ct.lineTo(202,ly+40);ct.closePath();ct.stroke();ct.fillStyle="#94a3b8";ct.fillText("Rozhodování",226,ly+44);
  ct.fillStyle="#1c1a14";rr(320,ly+30,35,18,4);ct.fill();ct.strokeStyle="#f59e0b";ct.lineWidth=1.5;rr(320,ly+30,35,18,4);ct.stroke();ct.fillStyle="#94a3b8";ct.fillText("⚠️ Problém",362,ly+44);
  ct.strokeStyle="#a78bfa";ct.lineWidth=1;ct.setLineDash([5,3]);ct.beginPath();ct.moveTo(35,ly+58);ct.lineTo(75,ly+58);ct.stroke();ct.setLineDash([]);ct.fillText("Message flow",82,ly+62);
  ct.restore();
}

function wp(ex,ey){const r=cv.getBoundingClientRect();return{x:(ex-r.left-ox)/sc,y:(ey-r.top-oy)/sc}}
function ht(mx,my){for(const n of ND){if(n.tp!==1)continue;const w=n.w||160,h=n.h||50;if(mx>=n.x&&mx<=n.x+w&&my>=n.y&&my<=n.y+h)return n}return null}

const tt=document.getElementById("tt");
cv.addEventListener("mousemove",e=>{if(dr){ox=e.clientX-dsx;oy=e.clientY-dsy;dd();return}const p=wp(e.clientX,e.clientY);const hi=ht(p.x,p.y);const ni=hi?hi.id:null;if(ni!==hov){hov=ni;dd()}if(hi&&hi.tip){let h=`<b>${hi.lb.replace(/\n/g," ")}</b>${hi.tip}`;if(hi.prb)h+=`<div class="pw">⚠️ ${hi.prb}</div>`;tt.innerHTML=h;tt.style.display="block";tt.style.left=(e.clientX+14)+"px";tt.style.top=(e.clientY+14)+"px"}else tt.style.display="none"});
cv.addEventListener("mousedown",e=>{if(e.button===0){dr=true;dsx=e.clientX-ox;dsy=e.clientY-oy}});
cv.addEventListener("mouseup",()=>dr=false);
cv.addEventListener("mouseleave",()=>{dr=false;tt.style.display="none";hov=null;dd()});
document.getElementById("cw").addEventListener("wheel",e=>{e.preventDefault();sc=Math.min(2,Math.max(.2,sc+(e.deltaY>0?-.05:.05)));document.getElementById("zl").textContent=Math.round(sc*100)+"%";dd()},{passive:false});
document.getElementById("zi").onclick=()=>{sc=Math.min(2,sc+.1);document.getElementById("zl").textContent=Math.round(sc*100)+"%";dd()};
document.getElementById("zo").onclick=()=>{sc=Math.max(.2,sc-.1);document.getElementById("zl").textContent=Math.round(sc*100)+"%";dd()};
document.getElementById("zr").onclick=()=>{sc=.72;ox=10;oy=10;document.getElementById("zl").textContent="72%";dd()};
document.getElementById("tP").onclick=()=>{const p=document.getElementById("pp");const v=p.classList.toggle("vis");document.getElementById("tP").classList.toggle("on",v);document.getElementById("tD").classList.toggle("on",!v)};
document.getElementById("tD").onclick=()=>{document.getElementById("pp").classList.remove("vis");document.getElementById("tP").classList.remove("on");document.getElementById("tD").classList.add("on")};
document.getElementById("ppx").onclick=()=>{document.getElementById("pp").classList.remove("vis");document.getElementById("tP").classList.remove("on");document.getElementById("tD").classList.add("on")};
window.addEventListener("resize",rs);
rs();
</script>
</body>
</html>
